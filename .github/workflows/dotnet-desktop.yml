name: Build and Release x64

on:
  release:
    types: [published]

jobs:
  build-and-release:
    runs-on: windows-latest
    env:
      BUILD_PLATFORM: x64
      BUILD_CONFIG: Release
      SOLUTION_PATH: AdbTools.sln
      PROJECT_PATH: AdbTools\AdbTools.csproj
      OUTPUT_DIR: bin\x64\Release
      OBJ_DIR: obj\x64\Release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1

    - name: Build solution
      run: |
        Write-Output "ğŸš€ Building solution (x64 Release)..."
        
        # é™é»˜æ„å»ºï¼ˆç§»é™¤è¯¦ç»†æ—¥å¿—ï¼‰
        msbuild $env:SOLUTION_PATH `
          /p:Configuration=$env:BUILD_CONFIG `
          /p:Platform=$env:BUILD_PLATFORM `
          /p:PlatformTarget=x64 `
          /p:OutputPath=$env:OUTPUT_DIR `
          /t:Clean,Build `
          /v:minimal `
          /nologo
        
        # æ£€æŸ¥è¾“å‡ºç›®å½•
        $outputPath = if (Test-Path $env:OUTPUT_DIR) { 
            $env:OUTPUT_DIR 
        } elseif (Test-Path $env:OBJ_DIR) {
            Write-Output "â„¹ï¸ Using output from $env:OBJ_DIR"
            $env:OBJ_DIR
        } else {
            Write-Error "âŒ Build output not found in either $env:OUTPUT_DIR or $env:OBJ_DIR"
            exit 1
        }
        
        Write-Output "âœ… Build successful! Output path: $outputPath"
      shell: pwsh

    - name: Prepare artifacts
      run: |
        # ç¡®å®šå®é™…çš„è¾“å‡ºè·¯å¾„
        $outputPath = if (Test-Path $env:OUTPUT_DIR) { $env:OUTPUT_DIR } else { $env:OBJ_DIR }
        
        Write-Output "ğŸ“¦ Preparing artifacts..."
        
        # æ¸…ç†å¹¶åˆ›å»ºartifactsç›®å½•
        if (Test-Path "artifacts") { Remove-Item -Path "artifacts" -Recurse -Force }
        New-Item -ItemType Directory -Path "artifacts" | Out-Null
        
        # å¤åˆ¶æ„å»ºè¾“å‡ºï¼ˆé™é»˜æ¨¡å¼ï¼‰
        Copy-Item -Path "$outputPath\*" -Destination "artifacts" -Recurse -Force
        
        # æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶
        Remove-Item -Path "artifacts\*.pdb", "artifacts\*.xml", "artifacts\*.vshost.*" -ErrorAction SilentlyContinue
        
        # éªŒè¯ä¸»ç¨‹åº
        if (-not (Test-Path "artifacts\AdbTools.exe")) {
            Write-Error "âŒ AdbTools.exe not found in artifacts"
            exit 1
        }
        
        Write-Output "âœ”ï¸ Artifacts prepared successfully"
      shell: pwsh

    - name: Create update package
      run: |
        Write-Output "ğŸ—œ Creating update.zip..."
        Compress-Archive -Path "artifacts\AdbTools.exe" -DestinationPath "artifacts\update.zip" -CompressionLevel Optimal
        Write-Output "âœ”ï¸ Update package created"
      shell: pwsh

    - name: Create full release package
      run: |
        Write-Output "ğŸ—œ Creating full release package..."
        Get-ChildItem -Path "artifacts\" -Exclude "*.zip" | 
          Compress-Archive -DestinationPath "artifacts\AdbTools.zip" -CompressionLevel Optimal -Force
        Write-Output "âœ”ï¸ Full release package created"
      shell: pwsh

    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./artifacts/update.zip
        asset_name: update.zip
        asset_content_type: application/zip

    - name: Upload Full Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./artifacts/AdbTools.zip
        asset_name: AdbTools.zip
        asset_content_type: application/zip
