name: Build and Release x64

on:
  release:
    types: [published]

jobs:
  build-and-release:
    runs-on: windows-latest
    env:
      BUILD_PLATFORM: x64
      BUILD_CONFIG: Release
      SOLUTION_PATH: AdbTools.sln
      MAIN_PROJECT_PATH: AdbTools\AdbTools.csproj
      UPDATE_PROJECT_PATH: Update\Update.csproj

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1

    - name: Build solution
      run: |
        Write-Output "ğŸš€ Building solution..."
        
        # æ„å»ºä¸»é¡¹ç›®ï¼ˆæ˜ç¡®æŒ‡å®šè¾“å‡ºè·¯å¾„ï¼‰
        msbuild $env:MAIN_PROJECT_PATH `
          /p:Configuration=$env:BUILD_CONFIG `
          /p:Platform=$env:BUILD_PLATFORM `
          /p:PlatformTarget=x64 `
          /p:OutputPath=bin\x64\Release\ `
          /v:minimal `
          /nologo
        
        # æ„å»ºUpdateé¡¹ç›®ï¼ˆæ˜ç¡®æŒ‡å®šè¾“å‡ºè·¯å¾„ï¼‰
        msbuild $env:UPDATE_PROJECT_PATH `
          /p:Configuration=$env:BUILD_CONFIG `
          /p:Platform=$env:BUILD_PLATFORM `
          /p:PlatformTarget=x64 `
          /p:OutputPath=bin\x64\Release\ `
          /v:minimal `
          /nologo
        
        # æ£€æŸ¥ä¸»ç¨‹åºè¾“å‡º
        $mainExePath = "AdbTools\bin\x64\Release\AdbTools.exe"
        if (-not (Test-Path $mainExePath)) {
            Write-Error "âŒ AdbTools.exe not found at $mainExePath"
            Write-Output "##[group]Directory structure"
            Get-ChildItem -Recurse
            Write-Output "##[endgroup]"
            exit 1
        }
        
        Write-Output "âœ… Build successful!"
      shell: pwsh

    - name: Prepare artifacts
      run: |
        Write-Output "ğŸ“¦ Preparing artifacts..."
        
        # åˆ›å»ºå¹²å‡€çš„artifactsç›®å½•
        if (Test-Path "artifacts") { Remove-Item -Path "artifacts" -Recurse -Force }
        New-Item -ItemType Directory -Path "artifacts" | Out-Null
        
        # å¤åˆ¶ä¸»ç¨‹åºæ–‡ä»¶
        $sourceDir = "AdbTools\bin\x64\Release"
        if (-not (Test-Path $sourceDir)) {
            Write-Error "âŒ Source directory not found: $sourceDir"
            exit 1
        }
        
        Copy-Item -Path "$sourceDir\*" -Destination "artifacts" -Recurse -Force
        
        # æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶
        Remove-Item -Path "artifacts\*.pdb", "artifacts\*.xml", "artifacts\*.vshost.*" -ErrorAction SilentlyContinue
        
        # éªŒè¯ä¸»ç¨‹åº
        if (-not (Test-Path "artifacts\AdbTools.exe")) {
            Write-Error "âŒ AdbTools.exe not found in artifacts"
            Get-ChildItem -Path "artifacts"
            exit 1
        }
        
        Write-Output "âœ”ï¸ Artifacts prepared"
      shell: pwsh

    - name: Create update package
      run: |
        Write-Output "ğŸ—œ Creating update.zip..."
        Compress-Archive -Path "artifacts\AdbTools.exe" -DestinationPath "artifacts\update.zip"
        Write-Output "âœ”ï¸ Update package created"
      shell: pwsh

    - name: Create full release package
      run: |
        Write-Output "ğŸ—œ Creating full release package..."
        Get-ChildItem -Path "artifacts\" -Exclude "*.zip" | 
          Compress-Archive -DestinationPath "artifacts\AdbTools.zip" -Force
        Write-Output "âœ”ï¸ Full release package created"
      shell: pwsh

    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./artifacts/update.zip
        asset_name: update.zip
        asset_content_type: application/zip

    - name: Upload Full Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./artifacts/AdbTools.zip
        asset_name: AdbTools.zip
        asset_content_type: application/zip
