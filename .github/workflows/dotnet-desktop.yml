name: Build and Release x64

on:
  release:
    types: [published]

jobs:
  build-and-release:
    runs-on: windows-latest
    env:
      BUILD_PLATFORM: x64
      BUILD_CONFIG: Release
      OUTPUT_DIR: bin\x64\Release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1

    - name: Build solution with detailed logging
      run: |
        # 启用详细日志记录
        msbuild AdbTools.sln `
          /p:Configuration=$env:BUILD_CONFIG `
          /p:Platform=$env:BUILD_PLATFORM `
          /p:PlatformTarget=x64 `
          /p:OutputPath=$env:OUTPUT_DIR `
          /v:diag `
          /flp:LogFile=msbuild.log;Verbosity=diagnostic
        
        # 打印构建日志
        type msbuild.log
        
        # 验证输出目录
        if not exist "$env:OUTPUT_DIR" (
          echo "##[error]Build output directory not found at $env:OUTPUT_DIR"
          echo "##[group]Directory structure"
          dir /s
          echo "##[endgroup]"
          exit 1
        )
      shell: cmd

    - name: Prepare artifacts
      run: |
        # 创建artifacts目录
        if not exist "artifacts" mkdir artifacts
        
        # 复制构建输出
        robocopy "$env:OUTPUT_DIR" "artifacts" /E /NFL /NDL /NJH /NJS /nc /ns /np
        
        # 清理不需要的文件
        powershell -command "
          Remove-Item -Path 'artifacts\*.pdb' -ErrorAction SilentlyContinue
          Remove-Item -Path 'artifacts\*.xml' -ErrorAction SilentlyContinue
          Remove-Item -Path 'artifacts\*.vshost.*' -ErrorAction SilentlyContinue
        "
      shell: cmd

    - name: Create update package
      run: |
        powershell -command "
          if (-not (Test-Path 'artifacts\AdbTools.exe')) {
            Write-Error 'AdbTools.exe not found in artifacts directory'
            Get-ChildItem -Path 'artifacts'
            exit 1
          }
          Compress-Archive -Path 'artifacts\AdbTools.exe' -DestinationPath 'artifacts\update.zip' -CompressionLevel Optimal
        "
      shell: cmd

    - name: Create full release package
      run: |
        powershell -command "
          Get-ChildItem -Path 'artifacts\' -Exclude '*.zip' | 
          Compress-Archive -DestinationPath 'artifacts\AdbTools.zip' -CompressionLevel Optimal -Force
        "
      shell: cmd

    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./artifacts/update.zip
        asset_name: update.zip
        asset_content_type: application/zip

    - name: Upload Full Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./artifacts/AdbTools.zip
        asset_name: AdbTools.zip
        asset_content_type: application/zip
