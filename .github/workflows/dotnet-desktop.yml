name: Build and Release x64

on:
  release:
    types: [published]

jobs:
  build-and-release:
    runs-on: windows-latest
    env:
      BUILD_PLATFORM: x64
      BUILD_CONFIG: Release
      SOLUTION_PATH: AdbTools.sln
      PROJECT_PATH: AdbTools\AdbTools.csproj
      OUTPUT_DIR: bin\x64\Release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1

    - name: Build solution
      run: |
        Write-Output "Building solution..."
        
        # 构建解决方案（修正了/flp参数语法）
        msbuild $env:SOLUTION_PATH `
          /p:Configuration=$env:BUILD_CONFIG `
          /p:Platform=$env:BUILD_PLATFORM `
          /p:PlatformTarget=x64 `
          /p:OutputPath=$env:OUTPUT_DIR `
          /t:Clean,Build `
          /v:diag `
          /flp:"LogFile=msbuild.log;Verbosity=diagnostic"
        
        # 显示构建日志
        Get-Content msbuild.log
        
        # 验证输出目录
        if (-not (Test-Path $env:OUTPUT_DIR)) {
          Write-Error "Build output directory not found at $env:OUTPUT_DIR"
          Write-Output "##[group]Directory structure"
          Get-ChildItem -Recurse
          Write-Output "##[endgroup]"
          exit 1
        }
      shell: pwsh

    - name: Prepare artifacts
      run: |
        # 创建artifacts目录
        if (Test-Path "artifacts") { Remove-Item -Path "artifacts" -Recurse -Force }
        New-Item -ItemType Directory -Path "artifacts" | Out-Null
        
        # 复制构建输出
        Copy-Item -Path "$env:OUTPUT_DIR\*" -Destination "artifacts" -Recurse -Force
        
        # 删除不需要的文件
        Remove-Item -Path "artifacts\*.pdb" -ErrorAction SilentlyContinue
        Remove-Item -Path "artifacts\*.xml" -ErrorAction SilentlyContinue
        Remove-Item -Path "artifacts\*.vshost.*" -ErrorAction SilentlyContinue
      shell: pwsh

    - name: Create update package
      run: |
        # 检查主程序是否存在
        if (-not (Test-Path "artifacts\AdbTools.exe")) {
          Write-Error "AdbTools.exe not found in artifacts directory"
          Get-ChildItem -Path "artifacts" -Recurse
          exit 1
        }
        
        # 创建update.zip
        Compress-Archive -Path "artifacts\AdbTools.exe" `
                         -DestinationPath "artifacts\update.zip" `
                         -CompressionLevel Optimal
      shell: pwsh

    - name: Create full release package
      run: |
        # 创建完整发布包
        Get-ChildItem -Path "artifacts\" -Exclude "*.zip" | 
          Compress-Archive -DestinationPath "artifacts\AdbTools.zip" `
                          -CompressionLevel Optimal -Force
      shell: pwsh

    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./artifacts/update.zip
        asset_name: update.zip
        asset_content_type: application/zip

    - name: Upload Full Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./artifacts/AdbTools.zip
        asset_name: AdbTools.zip
        asset_content_type: application/zip
