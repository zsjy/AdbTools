name: Build and Release x64

on:
  release:
    types: 
      - published

jobs:
  build-and-release:
    runs-on: windows-latest
    env:
      BUILD_PLATFORM: x64
      BUILD_CONFIG: Release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1

    - name: Setup NuGet
      uses: nuget/setup-nuget@v1
      with:
        nuget-version: '5.x'

    - name: Restore NuGet packages
      run: nuget restore AdbTools.sln

    - name: Build x64 Release configuration
      run: |
        msbuild AdbTools.sln `
          /p:Configuration=$env:BUILD_CONFIG `
          /p:Platform="$env:BUILD_PLATFORM" `
          /p:DeployOnBuild=true `
          /p:PublishProfile=FolderProfile-x64.pubxml `
          /p:PlatformTarget=x64

    - name: Verify build output
      run: |
        # 检查构建输出目录是否存在
        if not exist "bin\x64\Release" (
          echo "Build output directory not found!"
          dir /s bin
          exit 1
        )

    - name: Prepare artifacts directory
      run: |
        # 确保artifacts目录存在且为空
        if exist "artifacts" (rmdir /s /q artifacts)
        mkdir artifacts

    - name: Copy and filter build outputs
      run: |
        # 使用robocopy复制文件，更可靠
        robocopy "bin\x64\Release" "artifacts" /E /NFL /NDL /NJH /NJS /nc /ns /np
        
        # 使用PowerShell删除不需要的文件
        powershell -command "
          Remove-Item -Path 'artifacts\*.pdb' -ErrorAction SilentlyContinue
          Remove-Item -Path 'artifacts\*.xml' -ErrorAction SilentlyContinue
          Remove-Item -Path 'artifacts\*.vshost.*' -ErrorAction SilentlyContinue
          Remove-Item -Path 'artifacts\*.config' -ErrorAction SilentlyContinue
        "

    - name: Create update.zip (x64)
      run: |
        # 使用PowerShell创建zip文件
        powershell -command "
          $compress = @{
            Path = 'artifacts\AdbTools.exe'
            CompressionLevel = 'Optimal'
            DestinationPath = 'artifacts\update-x64.zip'
          }
          Compress-Archive @compress
        "

    - name: Create full release package (x64)
      run: |
        powershell -command "
          Get-ChildItem -Path 'artifacts\' -Exclude '*.zip' | 
          Compress-Archive -DestinationPath 'artifacts\full-release-x64.zip' -CompressionLevel Optimal -Force
        "

    - name: Upload Update Package
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./artifacts/update-x64.zip
        asset_name: update.zip
        asset_content_type: application/zip

    - name: Upload Full Release Package
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./artifacts/full-release-x64.zip
        asset_name: AdbTools.zip
        asset_content_type: application/zip
