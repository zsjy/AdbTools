name: Build and Release x64

on:
  release:
    types: [published]

jobs:
  build-and-release:
    runs-on: windows-latest
    env:
      BUILD_PLATFORM: x64
      BUILD_CONFIG: Release
      SOLUTION_PATH: AdbTools.sln
      PROJECT_PATH: AdbTools/AdbTools.csproj
      OUTPUT_DIR: bin/x64/Release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1

    - name: Build solution
      run: |
        # 清理并构建解决方案
        msbuild $env:SOLUTION_PATH `
          /p:Configuration=$env:BUILD_CONFIG `
          /p:Platform=$env:BUILD_PLATFORM `
          /p:PlatformTarget=x64 `
          /p:OutputPath=$env:OUTPUT_DIR `
          /t:Clean,Build `
          /v:diag `
          /flp:LogFile=msbuild.log;Verbosity=diagnostic
        
        # 打印构建日志
        type msbuild.log
        
        # 验证输出目录
        if not exist "$env:OUTPUT_DIR" (
          echo "##[error]Build output directory not found at $env:OUTPUT_DIR"
          echo "##[group]Directory structure"
          dir /s
          echo "##[endgroup]"
          exit 1
        )
      shell: cmd

    - name: Prepare artifacts
      run: |
        # 确保artifacts目录存在且为空
        if exist "artifacts" (rmdir /s /q artifacts)
        mkdir artifacts
        
        # 复制构建输出
        robocopy "$env:OUTPUT_DIR" "artifacts" /E /NFL /NDL /NJH /NJS /nc /ns /np
        
        # 删除不需要的文件
        powershell -command "
          Remove-Item -Path 'artifacts\*.pdb' -ErrorAction SilentlyContinue
          Remove-Item -Path 'artifacts\*.xml' -ErrorAction SilentlyContinue
          Remove-Item -Path 'artifacts\*.vshost.*' -ErrorAction SilentlyContinue
        "
      shell: cmd

    - name: Create update package
      run: |
        # 检查主程序是否存在
        if not exist "artifacts\AdbTools.exe" (
          echo "##[error]AdbTools.exe not found in artifacts directory"
          dir /s artifacts
          exit 1
        )
        
        # 创建update.zip
        powershell -command "
          Compress-Archive -Path 'artifacts\AdbTools.exe' `
                          -DestinationPath 'artifacts\update.zip' `
                          -CompressionLevel Optimal
        "
      shell: cmd

    - name: Create full release package
      run: |
        # 创建完整发布包
        powershell -command "
          Get-ChildItem -Path 'artifacts\' -Exclude '*.zip' | 
          Compress-Archive -DestinationPath 'artifacts\AdbTools.zip' `
                          -CompressionLevel Optimal -Force
        "
      shell: cmd

    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./artifacts/update.zip
        asset_name: update.zip
        asset_content_type: application/zip

    - name: Upload Full Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./artifacts/AdbTools.zip
        asset_name: AdbTools.zip
        asset_content_type: application/zip
